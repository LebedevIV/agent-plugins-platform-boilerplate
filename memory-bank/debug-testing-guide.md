# Руководство по тестированию отладочной версии

## Цель тестирования

Выявить причину проблемы с контекстом чатов при переключении между вкладками.

## Сценарий тестирования

### 1. Подготовка
1. Откройте DevTools (F12)
2. Перейдите на вкладку Console
3. Очистите консоль

### 2. Тестирование получения URL активной вкладки

#### Шаг 1: Открытие Ozon
1. Откройте https://www.ozon.ru/product/kostyum-sportivnyy-north-dot-1438414833/
2. Откройте side panel расширения
3. **Проверьте консоль** - должны появиться сообщения:
   ```
   [SidePanel] Получение URL активной вкладки...
   [SidePanel] Способ 1 - найденные вкладки: [...]
   [SidePanel] Устанавливаем URL: https://www.ozon.ru/...
   ```

#### Шаг 2: Открытие чата плагина
1. Найдите плагин Ozon в списке
2. Нажмите на него для открытия чата
3. **Проверьте консоль** - должны появиться сообщения:
   ```
   [PluginControlPanel] getPageKey вызван с currentTabUrl: https://www.ozon.ru/...
   [PluginControlPanel] Создан pageKey: https://www.ozon.ru/product/kostyum-sportivnyy-north-dot-1438414833/
   [useLazyChatSync] pageKey изменился: https://www.ozon.ru/product/kostyum-sportivnyy-north-dot-1438414833/
   ```

#### Шаг 3: Переключение на Perplexity
1. Откройте новую вкладку с https://www.perplexity.ai/search/extension-bisect-is-active-and-1nGPbp2GS4W6yurYrPGLlQ
2. **Проверьте консоль** - должны появиться сообщения:
   ```
   [SidePanel] Получение URL активной вкладки...
   [SidePanel] Способ 1 - найденные вкладки: [...]
   [SidePanel] Устанавливаем URL: https://www.perplexity.ai/...
   [useLazyChatSync] pageKey изменился: https://www.perplexity.ai/search/extension-bisect-is-active-and-1nGPbp2GS4W6yurYrPGLlQ
   ```

## Ожидаемые результаты

### ✅ Правильное поведение
- При переключении на Perplexity side panel должен показать список плагинов
- В консоли должны быть сообщения об изменении pageKey
- Черновик чата должен очиститься

### ❌ Проблемное поведение
- Чат Ozon продолжает отображаться на странице Perplexity
- В консоли нет сообщений об изменении pageKey
- URL активной вкладки не обновляется

## Диагностика проблем

### Проблема 1: URL не обновляется
**Симптомы:** В консоли нет сообщений о получении URL
**Возможные причины:**
- Ограничения API в side panel
- Неправильные permissions в manifest
- Ошибки в chrome.tabs.query

### Проблема 2: pageKey не изменяется
**Симптомы:** URL обновляется, но pageKey остается старым
**Возможные причины:**
- Ошибка в функции getPageKey
- Проблема с передачей currentTabUrl
- Кэширование в React

### Проблема 3: Состояние не сбрасывается
**Симптомы:** pageKey изменяется, но чат не очищается
**Возможные причины:**
- Проблема в useLazyChatSync
- Неправильные зависимости useEffect
- Ошибка в сбросе состояния

## Следующие шаги

После тестирования:
1. Зафиксируйте все сообщения из консоли
2. Определите, на каком этапе происходит сбой
3. Сообщите результаты для дальнейшей диагностики

## Альтернативные решения

Если проблема не решается:
1. Использование chrome.sidePanel.getOptions()
2. Передача контекста через background script
3. Использование chrome.runtime.onMessage для синхронизации
4. Реализация собственного механизма отслеживания вкладок 