# Система ленивой синхронизации чатов

## Обзор

Система ленивой синхронизации чатов (Lazy Chat Sync) - это продвинутая архитектура для управления чатами плагинов с оптимизированной производительностью и улучшенным пользовательским опытом.

## Основные принципы

### 1. Ленивая инициализация
- Чат создается только при начале ввода пользователя
- Минимальный порог: 10 символов для создания чата
- Автоматическое создание без явного действия пользователя

### 2. Debounce синхронизация
- Задержка 1 секунда перед сохранением черновика
- Предотвращение избыточных запросов к базе данных
- Оптимизация производительности при быстром вводе

### 3. Пороговые значения
- **Минимум**: 10 символов для начала синхронизации
- **Максимум**: 1000 символов для предотвращения перегрузки
- **Оптимальный диапазон**: 10-1000 символов для эффективной работы

### 4. Система черновиков
- Отдельное хранилище для черновиков в IndexedDB
- Автоматическое восстановление при перезагрузке страницы
- Очистка черновиков после отправки сообщения

## Архитектура

### Компоненты системы

#### 1. API Layer (`plugin-chat-api.ts`)
```typescript
// Основные методы
createChatIfNotExists(pluginId, pageKey) // Ленивая инициализация
saveDraft(pluginId, pageKey, draftText)  // Сохранение черновика
getDraft(pluginId, pageKey)              // Получение черновика
deleteDraft(pluginId, pageKey)           // Удаление черновика
```

#### 2. React Hook (`useLazyChatSync.ts`)
```typescript
const {
  message,
  setMessage,
  isDraftSaved,
  isDraftLoading,
  draftError,
  loadDraft,
  clearDraft,
} = useLazyChatSync({
  pluginId,
  pageKey,
  debounceMs: 1000,
  minLength: 10,
  maxLength: 1000,
});
```

#### 3. UI Components
- `DraftStatus` - индикатор статуса синхронизации
- `PluginControlPanel` - основной интерфейс чата
- `PluginChatsTab` - административная панель

### Поток данных

```
Пользователь вводит текст
    ↓
useLazyChatSync.setMessage()
    ↓
Проверка пороговых значений
    ↓
[Если >= 10 символов] Создание чата
    ↓
Debounce таймер (1 сек)
    ↓
Сохранение черновика в IndexedDB
    ↓
Обновление UI статуса
    ↓
[При отправке] Очистка черновика
```

## Реализация

### 1. База данных (IndexedDB v2)

```typescript
// Структура базы данных
const DB_NAME = 'plugin-chats-db';
const STORE_NAME = 'plugin-chats';        // Основные чаты
const DRAFTS_STORE_NAME = 'chat-drafts';  // Черновики

// Схема черновика
interface ChatDraft {
  draftKey: string;      // `${pluginId}::${pageKey}`
  pluginId: string;
  pageKey: string;
  text: string;
  updatedAt: number;
}
```

### 2. Хук useLazyChatSync

```typescript
// Основная логика
const setMessage = useCallback((text: string) => {
  setMessageState(text);
  
  // Очистка предыдущего таймера
  if (debounceRef.current) {
    clearTimeout(debounceRef.current);
  }

  // Проверка условий для синхронизации
  const shouldSync = text.length >= minLength && text.length <= maxLength;
  
  if (shouldSync) {
    // Создаем чат при первом вводе
    if (text.length === minLength) {
      createChatIfNeeded();
    }
    
    // Устанавливаем debounce для сохранения черновика
    debounceRef.current = setTimeout(() => {
      saveDraft(text);
    }, debounceMs);
  } else if (text.length === 0) {
    // Если текст пустой, очищаем черновик
    clearDraft();
  }
}, [minLength, maxLength, debounceMs, createChatIfNeeded, saveDraft, clearDraft]);
```

### 3. Компонент DraftStatus

```typescript
// Состояния индикатора
const getStatusClass = () => {
  if (isDraftLoading) return 'draft-status loading';
  if (draftError) return 'draft-status error';
  if (isDraftSaved) return 'draft-status saved';
  if (messageLength > 0 && messageLength < minLength) return 'draft-status pending';
  if (messageLength >= minLength && messageLength <= maxLength) return 'draft-status ready';
  if (messageLength > maxLength) return 'draft-status error';
  return 'draft-status';
};
```

## Пользовательский опыт

### Визуальные индикаторы

1. **Загрузка черновика** - анимированный спиннер
2. **Ожидание синхронизации** - оранжевый индикатор с количеством символов
3. **Готов к синхронизации** - синий индикатор "будет сохранен автоматически"
4. **Сохранено** - зеленый индикатор с галочкой
5. **Ошибка** - красный индикатор с описанием проблемы

### Анимации

```css
/* Анимация появления */
.draft-status {
  animation: draftStatusFadeIn 0.3s ease-out;
}

/* Анимация сохранения */
.draft-status.saved svg {
  animation: draftStatusSaved 0.6s ease-out;
}
```

### Автоматическое восстановление

- При загрузке страницы автоматически загружается черновик
- Пользователь может продолжить работу с того места, где остановился
- Прозрачная синхронизация между вкладками

## Производительность

### Оптимизации

1. **LRU кэширование** - кэш на 50 чатов в памяти
2. **Debounce** - предотвращение избыточных запросов
3. **Пороговые значения** - синхронизация только при необходимости
4. **Ленивая загрузка** - создание чатов по требованию

### Метрики

- **Время отклика**: < 100ms для локальных операций
- **Задержка синхронизации**: 1 секунда (настраивается)
- **Использование памяти**: Оптимизировано через LRU кэш
- **Размер черновиков**: Ограничен 1000 символами

## Административное управление

### DevTools панель

Обновленная DevTools панель предоставляет:

1. **Вкладка "Чаты"** - управление основными чатами
2. **Вкладка "Черновики"** - управление черновиками
3. **Экспорт данных** - выгрузка чатов и черновиков в JSON
4. **Просмотр деталей** - модальные окна с полной информацией

### API для администрации

```typescript
// Получение всех черновиков
LIST_PLUGIN_CHAT_DRAFTS

// Удаление черновика
SAVE_PLUGIN_CHAT_DRAFT (с пустым текстом)

// Экспорт всех данных
// Включает чаты и черновики с метаданными
```

## Конфигурация

### Настройки по умолчанию

```typescript
const defaultConfig = {
  debounceMs: 1000,    // Задержка синхронизации
  minLength: 10,        // Минимум символов для синхронизации
  maxLength: 1000,      // Максимум символов
  lruLimit: 50,         // Размер LRU кэша
  dbVersion: 2,         // Версия базы данных
};
```

### Кастомизация

```typescript
// Настройка для конкретного плагина
const chatSync = useLazyChatSync({
  pluginId: 'my-plugin',
  pageKey: getPageKey(),
  debounceMs: 500,      // Более быстрая синхронизация
  minLength: 5,         // Меньший порог
  maxLength: 500,       // Меньший лимит
});
```

## Безопасность

### Защита данных

1. **Изоляция по плагинам** - каждый плагин имеет свои чаты
2. **Изоляция по страницам** - чаты разделены по URL
3. **Локальное хранение** - данные не покидают браузер
4. **Валидация входных данных** - проверка всех параметров

### Очистка данных

1. **Автоматическая очистка** черновиков после отправки
2. **Ручная очистка** через DevTools панель
3. **Ограничение размера** для предотвращения переполнения
4. **LRU вытеснение** для управления памятью

## Мониторинг и отладка

### Логирование

```typescript
// Логи для отладки
console.log('Creating chat for:', pluginId, pageKey);
console.log('Saving draft:', draftText.length, 'characters');
console.log('Draft saved successfully');
```

### DevTools интеграция

- Отображение всех черновиков в реальном времени
- Статистика по плагинам и страницам
- Возможность ручного управления данными
- Экспорт для анализа

## Будущие улучшения

### Планируемые функции

1. **Умная синхронизация** - адаптивная задержка на основе активности
2. **Сжатие данных** - оптимизация размера черновиков
3. **Офлайн поддержка** - работа без интернета
4. **Конфликт-резолюшн** - разрешение конфликтов при синхронизации
5. **Аналитика** - метрики использования чатов

### Технические улучшения

1. **Web Workers** - асинхронная обработка в фоне
2. **Service Workers** - кэширование и офлайн поддержка
3. **Compression** - сжатие больших черновиков
4. **Encryption** - шифрование чувствительных данных

## Заключение

Система ленивой синхронизации чатов обеспечивает:

- **Оптимальную производительность** через debounce и пороговые значения
- **Отличный пользовательский опыт** с автоматическим восстановлением
- **Надежное хранение данных** в IndexedDB с версионированием
- **Административный контроль** через DevTools панель
- **Масштабируемость** для будущих улучшений

Система полностью интегрирована в архитектуру Agent-Plugins-Platform и следует всем принципам разработки проекта. 